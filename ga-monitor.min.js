var googleanalyzetime = new Date().getTime();
var loader_preloading_step = 1;
var loader_hall_step = 1;
var loader_hall_step_2 = 1;
var character_verification_operation = 1;
var lobby_load_res_start = 1;
var requst_join_channel = 1;
var enter_room_list = 1;
var enter_room =1;
var create_character = 1;
var create_character_sucess = 1;
var enter_channel_list = 1;
var loader_game_client_start = 1;
var enter_game = 1;
var first_kill_player = 1;
var closed_by_loginServer = 1;
var connect_to_loginServer_error = 1;
var connect_to_roomServer_error = 1;
var closed_by_roomServer = 1;
var closed_by_battle = 1;
var security_error_battle = 1;
var newuser = "",
	$getgamehref = document.referrer,
	$thegamestatus = $getgamehref.match('facebook.com');
var cdn = "",
	$getlocation = document.location.href,
	$cdn_status = $getlocation.match('cdn=1');

	if ($cdn_status) {
		cdn = 'cdn_';
	};
	//console.log($getgamehref, $thegamestatus);
var $channel = 'none';
if ($isminiclient) {
	$channel = 'mini_Client';
}else if ($getlocation.match('lobbywithregister')) {
	var $url = document.location.search.split('&fbSource=');
	if ($url[1]) {
	    $channel = $url[1].split('&')[0];
	}
};
if (!$fbuserid) {
	$fbuserid = 'nofacebookid';
};
(function () {
	var a = function () {
		this.timer = null;
		this.speed = 2;
		this.step = 0;
		this.listenLoop = 0;
		this.maxWait = 1;
		this.dialogDOM = [];
	};
	a.prototype = {
		listen : function () {
			//var b = ["flashVersion", "loader_preloading_step", "loader_hall_step", "loader_hall_step_2", "create_character", "create_character_view_added_to_stage", "lobby_load_res_start", "enter_channel_list", "lobby_load_res_compele"];
			var b = ["flashVersion", "loader_preloading_step"];
			var e = this;
			var c = b.length;
			var d = parseInt(this.maxWait / this.speed + 0.99999);
			this.timer = setInterval(function () {
					var g = b[e.step];
					if (!!document.getElementById("loader_preloading_step")) {
						clearInterval(e.timer);
						return false;
					}
					if (!!document.getElementById(g)) {
						e.step++;
						e.listenLoop = 0;
						var f = (g == "create_character" || g == "create_character_view_added_to_stage");
						if (e.step >= c || f) {
							clearInterval(e.timer);
						}
					} else {
						if (++e.listenLoop > d) {
							e.view(function () {
								e.setSwfPosition("-9999px");
								e.dialogDOM = $("#download-log-dialog");
								var h = setInterval(function () {
										if (!!document.getElementById("loader_preloading_step")) {
											e.clearView();
											clearInterval(h);
										}
									}, 100);
							});
							clearInterval(e.timer);
						}
					}
				}, this.speed * 1000);
		},
		view : function (b) {
			if (this.dialogDOM.length) {
				return false;
			}
			//$("body").append('<div id="download-log-dialog" style="position:absolute;top:40%;left:50%;margin-left:-74px;"><img src="./resource/img/Carregando.jpg" border="0" usemap="#downloadMap" alt="Se você tiver demorando para carregar o jogo, favor atualizar novamente. Obrigado." /><map name="downloadMap" id="downloadMap"><area href="javascript:XcAppMonitor.refreshWin();" shape="rect" coords="636,210,738,248" title="atualizar" /><area href="javascript:XcAppMonitor.clearView();" shape="rect" coords="753,210,854,248" title="esperar" /></map></div>');
			//20150826去掉手枪画面，只保留文字提示，同时提示信息会在载入页面5秒以后显示
			$("body").append('<div id="download-log-dialog" style="position:absolute;top:70%;left:50%;margin-left:-177px;"><img src="./resource/img/flashplayer.jpg" border="0"  usemap="#mydialog"/><map name="mydialog"><area shape="rect" coords="0,0,354,96" href="https://get.adobe.com/cn/flashplayer/" target="_blank"></map></br> Carregando...Favor seja paciente :)</br><map name="downloadMap" id="downloadMap"><area href="javascript:XcAppMonitor.refreshWin();" shape="rect" coords="636,210,738,248" title="atualizar" /><area href="javascript:XcAppMonitor.clearView();" shape="rect" coords="753,210,854,248" title="esperar" /></map></div>');

			if (b && typeof b == "function") {
				b.call(this);
			}
		},
		clearView : function () {
			if (this.dialogDOM.length) {
				this.dialogDOM.remove();
				this.setSwfPosition("50%");
			}
		},
		setSwfPosition : function (b) {
			$("#Swf").css("left", b);
		},
		refreshWin : function () {
			window.location = window.location;
		}
	};
	//XcAppMonitor = this.XcAppMonitor = new a();
	//XcAppMonitor.listen();
}).call(window);
var _ga = {
	app : "",
	user : "",
	server : "0",
	version : "0",
	device : "",
	platform : ""
};
function facebook_init()
{
	/*var params = {};
	params[FB.AppEvents.ParameterNames.SUCCESS] = 'init_game';
	FB.AppEvents.logEvent(
    FB.AppEvents.EventNames.SUCCESS,
    1,  // numeric value for this event - in this case, none
    params);
	//FB.AppEvents.logEvent(FB.AppEvents.EventNames.COMPLETED_TUTORIAL);*/
}
function saveStage(b, a) {
	saveEvent("saveEvent", b, a);
}
function saveFlashVer(b, a) {

	saveEvent("saveEvent", b, a);
}
function saveConsoleLog(b, a) {
	saveEvent("saveConsoleLog", b, a);
}

//FA事件添加函数
function facebookLog(options) {
	if ($thegamestatus) {
		var $cdnparams = 0;
		if ($cdn_status) {
			$cdnparams = 1;
		}
		var params = {
			'cdn': $cdnparams,
		    'channel': $channel
		};
		//测试代码
		//ga('send', 'event', 'FATEST_404_' + options, 'Testing', $channel, 0);
		//END
		FB.AppEvents.logEvent(
		    options,
		    null,
		    params
		);
	};
}

/*//GA事件添加
function googleLog() {
	var gaMethod = arguments[0] || 'send',
		gaEvent = arguments[1] || 'event',
		gaCategory = arguments[2] || 'eventCategory',
		gaAction = arguments[3] || 'click',
		gaLabel = arguments[4] || 'label',
		gaValue = arguments[5] || 0;

	ga(gaMethod, {
	  	'hitType': gaEvent,
	  	'eventCategory': gaCategory,
	  	'eventAction': gaAction,
	  	'eventLabel': gaLabel,
	  	'eventValue': gaValue
	});
}*/

function saveEvent(d, g, f) {

	var a = "//applog-bloodstrike.xcloudgame.com/log_event?method=" + d;
	app = escape(String(_ga.app));
	user = escape(String(_ga.user));
	server = parseInt(_ga.server);
	version = _ga.version;
	device = escape(String(_ga.device));
	platform = escape(String(_ga.platform));
	g = escape(String(g));
	f = escape(String(f));
	var e = location.href;
	dest = a + "&app=" + app + "&user=" + user + "&server=" + server + "&version=" + version + "&device=" + device + "&platform=" + platform + "&event=" + g + "&event_args=" + f + "&cnu=" + String(Math.random());
	var c = document.getElementById(g);
	if (c) {
		document.getElementById(g).src = dest;
	} else {
		var b = document.createElement("img");
		b.setAttribute("id", g);
		b.setAttribute("src", dest);
		b.setAttribute("border", 0);
		b.setAttribute("width", 1);
		b.setAttribute("height", 1);
		document.body.appendChild(b);
	}

	//添加设置cookie
	function addCookie(name, value, path){
	    var name = escape(name),
	        value = escape(value),
	        expires = new Date(),
	        hour = 23 - expires.getHours(),
	        min = 59 - expires.getMinutes(),
	        second = 59 - expires.getSeconds(),
	        ms = (3600 * hour + 60 * min + second) * 1000;
	    expires.setTime(expires.getTime() + ms);//设置为当天有效
	    //console.log(value, ms);
	    path = path == "" ? "" : ";path=" + path;
	    var _expires = (typeof days) == "string" ? "" : ";expires=" + expires.toUTCString();
	    document.cookie = name + "=" + value + _expires + path;
	}

	//获取cookie的值，根据cookie的键获取值
	function getCookieValue(name){
	    var name = escape(name);
	    var allcookies = document.cookie;
	    name += "=";
	    var pos = allcookies.indexOf(name);
	    if (pos != -1){
	        var start = pos + name.length,
	            end = allcookies.indexOf(";",start);
	        if (end == -1) end = allcookies.length;
	        var value = allcookies.substring(start,end);
	        return (value);
	    }else{
	        return "";
	    }
	}

	if ("flashVersion" == g) {
		//游戏被启动了
		flashVersion = 0;
		var flashversiongoogletag = setInterval(function()
		{
			ga('send', 'event', cdn + 'after_flashVersion', 'trigger', $channel ,0);
			facebookLog('after_flashVersion');
			clearInterval(flashversiongoogletag);
		}, 1000);
		facebook_init();
		//facebookLog('flashVersion');
		//consolo.log("flashVersion");
	}

	if ("loader_preloading_step" == g && 1 == loader_preloading_step) {
		//游戏被启动了
		loader_preloading_step = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'loader_preloading_step', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('loader_preloading_step');
	}

	if ("loader_hall_step" == g && 1 == loader_hall_step) {
		//游戏被启动了
		loader_hall_step = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'loader_hall_step', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('loader_hall_step');
	}

	if ("create_character" == g && 1 == create_character) {
		//游戏被启动了
		create_character = 0;
		newuser = "new_";
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'create_character', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('create_character');
	}

	if ("loader_hall_step_2" == g && 1 == loader_hall_step_2) {
		//游戏被启动了
		loader_hall_step_2 = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'loader_hall_step_2', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('loader_hall_step_2');
	}

	if ("character_verification_operation" == g && 1 == character_verification_operation) {
		//点击创建角色
		character_verification_operation = 0;
		newuser = "new_";
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + "character_verification_operation", 'click', $channel, timenow - googleanalyzetime);
		facebookLog('character_verification_operation');
	}
	if ("create_character_sucess" == g && 1 == create_character_sucess) {
		//成功创建角色
		create_character_sucess = 0;
		var timenow = new Date().getTime();
		newuser = "new_";
		ga('send', 'event', newuser + cdn + 'create_character_sucess', 'click', $channel, timenow - googleanalyzetime);
		facebookLog('create_character_sucess');
	}

	if ("enter_channel_list" == g && 1 == enter_channel_list) {
		//游戏停止在这里了，等待用户操作了
		enter_channel_list = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'enter_channel_list', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('enter_channel_list');
		//if( level ){
			if (!$isminiclient) {
				var Sys={};
			    var ua=navigator.userAgent.toLowerCase();
			    var s;
			    (s=ua.match(/msie ([\d.]+)/))?Sys.ie=s[1]:
			    (s=ua.match(/firefox\/([\d.]+)/))?Sys.firefox=s[1]:
			    (s=ua.match(/chrome\/([\d.]+)/))?Sys.chrome=s[1]:
			    (s=ua.match(/opera.([\d.]+)/))?Sys.opera=s[1]:
			    (s=ua.match(/version\/([\d.]+).*safari/))?Sys.safari=s[1]:0;
			    if(Sys.chrome){
			    	//Js判断为谷歌chrome浏览器
	        		var popnoticeCount = parseInt(getCookieValue("popnoticeCount"));
				    if (!popnoticeCount) {
				        addCookie('popnoticeCount', 1, '/');
				        //GpuInfo();
				    }
	    		}
			};
			//showpopnotice();
		//}
		if (navigator.language !== 'zh-CN') {
	        $('#new-side-btn').show();
	    }
		$('.xc-ads-events').show();
		$('.fbbox').show();
		$('.gmbox').show();
	}

	if ("lobby_load_res_start" == g && 1 == lobby_load_res_start) {
		//游戏被启动了
		lobby_load_res_start = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'lobby_load_res_start', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('lobby_load_res_start');
	}

	if ("requst_join_channel" == g && 1 == requst_join_channel) {
		//游戏被启动了
		requst_join_channel = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'requst_join_channel', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('requst_join_channel');
	}

	if ("enter_room_list" == g && 1 == enter_room_list) {
		//游戏被启动了
		enter_room_list = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'enter_room_list', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('enter_room_list');
	}

	if ("enter_room" == g && 1 == enter_room) {
		//游戏被启动了
		enter_room = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'enter_room', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('enter_room');
	}

	if ("loader_game_client_start" == g && 1 == loader_game_client_start) {
		//点击加载战斗游戏
		loader_game_client_start = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'loader_game_client_start', 'click', $channel, timenow - googleanalyzetime);
		facebookLog('loader_game_client_start');
	}

	if ("enter_game" == g && 1 == enter_game) {
		//正式进入战斗游戏
		enter_game = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'enter_game', 'loading', $channel, timenow - googleanalyzetime);
		facebookLog('enter_game');
		//ga('send', 'event', 'idtest1', 'Testing', $fbuserid, timenow - googleanalyzetime);
	}

	if ("first_kill_player" == g && 1 == first_kill_player) {
		//正式进入战斗游戏
		first_kill_player = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'first_kill_player', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('first_kill_player');
		//ga('send', 'event', 'idtest2', 'Testing', $fbuserid, timenow - googleanalyzetime);
	}

	if ("click_channel" == g && 1 == click_channel) {
		//正式进入战斗游戏
		click_channel = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'click_channel', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('click_channel');
	}

	if ("click_join_channel_btn" == g && 1 == click_join_channel_btn) {
		//正式进入战斗游戏
		click_join_channel_btn = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'click_join_channel_btn', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('click_join_channel_btn');
	}

	if ("double_click_channel" == g && 1 == double_click_channel) {
		//正式进入战斗游戏
		double_click_channel = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'double_click_channel', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('double_click_channel');
	}

	if ("enter_match_scene" == g && 1 == enter_match_scene) {
		//正式进入战斗游戏
		enter_match_scene = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'enter_match_scene', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('enter_match_scene');
	}
	//2015-12-11添加六个
	//开始
	if ("closed_by_loginServer" == g && 1 == closed_by_loginServer) {
		//正式进入战斗游戏
		closed_by_loginServer = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'closed_by_loginServer', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('closed_by_loginServer');
		//ga('send', 'event', 'Test_closed_by_loginServer', 'Testing', $fbuserid, timenow - googleanalyzetime);
	}

	if ("connect_to_loginServer_error" == g && 1 == connect_to_loginServer_error) {
		//正式进入战斗游戏
		connect_to_loginServer_error = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'connect_to_loginServer_error', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('connect_to_loginServer_error');
		//ga('send', 'event', 'Test_connect_to_loginServer_error', 'Testing', $fbuserid, timenow - googleanalyzetime);
	}

	if ("connect_to_roomServer_error" == g && 1 == connect_to_roomServer_error) {
		//正式进入战斗游戏
		connect_to_roomServer_error = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'connect_to_roomServer_error', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('connect_to_roomServer_error');
		//ga('send', 'event', 'Test_connect_to_roomServer_error', 'Testing', $fbuserid, timenow - googleanalyzetime);
	}

	if ("closed_by_roomServer" == g && 1 == closed_by_roomServer) {
		//正式进入战斗游戏
		closed_by_roomServer = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'closed_by_roomServer', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('closed_by_roomServer');
		//ga('send', 'event', 'Test_closed_by_roomServer', 'Testing', $fbuserid, timenow - googleanalyzetime);
	}

	if ("closed_by_battle" == g && 1 == closed_by_battle) {
		//正式进入战斗游戏
		closed_by_battle = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'closed_by_battle', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('closed_by_battle');
		//ga('send', 'event', 'Test_closed_by_battle', 'Testing', $fbuserid, timenow - googleanalyzetime);
	}

	if ("security_error_battle" == g && 1 == security_error_battle) {
		//正式进入战斗游戏
		security_error_battle = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'security_error_battle', 'trigger', $channel, timenow - googleanalyzetime);
		facebookLog('security_error_battle');
		//ga('send', 'event', 'Test_security_error_battle', 'Testing', $fbuserid, timenow - googleanalyzetime);
	}
	//结束
}


var google_analysis_recharge_number = 1;
var google_analysis_purchase_items_number = 1;
function google_analysis_recharge()
{
	if(1 == google_analysis_recharge_number)
	{
		google_analysis_recharge_number = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'recharge', 'clicks', $channel, timenow - googleanalyzetime);
		facebookLog('recharge');
	}

}

function google_analysis_purchase_items()
{
	if(1 == google_analysis_purchase_items_number)
	{
		google_analysis_purchase_items_number = 0;
		var timenow = new Date().getTime();
		ga('send', 'event', newuser + cdn + 'purchase_items', 'clicks', $channel, timenow - googleanalyzetime);
		facebookLog('purchase_items');
	}
}
